
#include <stdint.h>
#include <stdbool.h>
#include <ctype.h>
#include "disp_wrapper.h"
#include "usb_wrapper.h"
#include "font_wrapper.h"

const uint8_t G_font[][G_fontHeight+1] = {
    {'A', 0x1c, 0x22, 0x41, 0x41, 0x41, 0x41, 0x7f, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00 } /* 0 */,
    {'B', 0x7e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x7e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x7e, 0x00 } /* 1 */,
    {'C', 0x3e, 0x41, 0x41, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x41, 0x41, 0x3e, 0x00 } /* 2 */,
    {'D', 0x7c, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x7c, 0x00 } /* 3 */,
    {'E', 0x7f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40 ,0x40, 0x40, 0x7f, 0x00 } /* 4 */,
    {'F', 0x7f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00 } /* 5 */,
    {'G', 0x3e, 0x40, 0x40, 0x40, 0x40, 0x40, 0x47, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3e, 0x00 } /* 6 */,
    {'H', 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x7f, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00 } /* 7 */,
    {'I', 0x3e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x3e, 0x00 } /* 8 */,
    {'J', 0x0f, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x42, 0x42, 0x42, 0x3c, 0x00 } /* 9 */,
    {'K', 0x41, 0x42, 0x42, 0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44, 0x42, 0x42, 0x41, 0x00 } /* 10 */,
    {'L', 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7f, 0x00 } /* 11 */,
    {'M', 0x41, 0x63, 0x63, 0x55, 0x55, 0x49, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00 } /* 12 */,
    {'N', 0x41, 0x61, 0x61, 0x51, 0x51, 0x49, 0x49, 0x45, 0x45, 0x43, 0x43, 0x43, 0x41, 0x00 } /* 13 */,
    {'O', 0x1c, 0x22, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x22, 0x1c, 0x00 } /* 14 */,
    {'P', 0x7e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x7e, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00 } /* 15 */,
    {'Q', 0x1c, 0x22, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x22, 0x1c, 0x06 } /* 16 */,
    {'R', 0x7e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x7e, 0x50, 0x48, 0x44, 0x42, 0x42, 0x41, 0x00 } /* 17 */,
    {'S', 0x3e, 0x41, 0x41, 0x40, 0x40, 0x40, 0x3e, 0x01, 0x01, 0x01, 0x41, 0x41, 0x3e, 0x00 } /* 18 */,
    {'T', 0x7f, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00 } /* 19 */,
    {'U', 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3e, 0x00 } /* 20 */,
    {'V', 0x41, 0x41, 0x41, 0x41, 0x22, 0x22, 0x22, 0x14, 0x14, 0x14, 0x08, 0x08, 0x08, 0x00 } /* 21 */,
    {'W', 0x41, 0x42, 0x41, 0x41, 0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x55, 0x22, 0x00 } /* 22 */,
    {'X', 0x41, 0x41, 0x22, 0x22, 0x14, 0x14, 0x08, 0x14, 0x14, 0x22, 0x22, 0x41, 0x41, 0x00 } /* 23 */,
    {'Y', 0x41, 0x41, 0x22, 0x22, 0x14, 0x14, 0x14, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1c, 0x00 } /* 24 */,
    {'Z', 0x7f, 0x03, 0x01, 0x02, 0x04, 0x04, 0x08, 0x10, 0x10, 0x20, 0x40, 0x60, 0x7f, 0x00 } /* 25 */,
    {'0', 0x3e, 0x43, 0x43, 0x45, 0x45, 0x49, 0x49, 0x49, 0x51, 0x51, 0x61, 0x61, 0x3e, 0x00 } /* 26 */,
    {'1', 0x08, 0x18, 0x28, 0x58, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x7f, 0x00 } /* 27 */,
    {'2', 0x3e, 0x41, 0x01, 0x01, 0x01, 0x01, 0x0e, 0x70, 0x40, 0x40, 0x40, 0x40, 0x7f, 0x00 } /* 28 */,
    {'3', 0x3e, 0x41, 0x41, 0x01, 0x01, 0x01, 0x0e, 0x01, 0x01, 0x01, 0x41, 0x41, 0x3e, 0x00 } /* 29 */,
    {'4', 0x02, 0x06, 0x0a, 0x12, 0x22, 0x42, 0x7f, 0x02, 0x02, 0x02, 0x02, 0x02, 0x1f, 0x00 } /* 30 */,
    {'5', 0x7f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7e, 0x01, 0x01, 0x01, 0x41, 0x41, 0x3e, 0x00 } /* 31 */,
    {'6', 0x3e, 0x41, 0x41, 0x40, 0x40, 0x40, 0x7e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3e, 0x00 } /* 32 */,
    {'7', 0x7f, 0x01, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00 } /* 33 */,
    {'8', 0x3e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3e, 0x00 } /* 34 */,
    {'9', 0x3e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3f, 0x01, 0x01, 0x01, 0x01, 0x41, 0x3e, 0x00 } /* 35 */,
    {' ', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } /* 36 */,
    {'<', 0x00, 0x01, 0x03, 0x0e, 0x1c, 0x38, 0xf0, 0x38, 0x1c, 0x0e, 0x03, 0x01, 0x00, 0x00 } /* 37 */,
    {'>', 0x00, 0x40, 0x60, 0x38, 0x1c, 0x0e, 0x0f, 0x0e, 0x1c, 0x38, 0x60, 0x40, 0x00, 0x00 } /* 37 */,
    {'%', 0x00, 0x31, 0x52, 0x52, 0x64, 0x64, 0x08, 0x13, 0x13, 0x25, 0x25, 0x46, 0x00, 0x00 } /* 39 */,
    {':', 0x00, 0x00, 0x1c, 0x1c, 0x1c, 0x00, 0x00, 0x1c, 0x1c, 0x1c, 0x00, 0x00, 0x00, 0x00 } /* 40 */,
    {'/', 0x01, 0x02, 0x02, 0x04, 0x04, 0x08, 0x08, 0x08, 0x10, 0x10, 0x20, 0x20, 0x40, 0x00 } /* 41 */,
    {'-', 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 } /* 42 */
};

enum {LETTER_A=0, DIGIT_0=26, SPACE=36, LT=37, GT=38, PERCENT=39, COLON=40,
      SLASH=41, DASH=42};


uint8_t FONT_charToIndex(char ch);
uint8_t FONT_getTxtLineNumber(uint8_t pixLineNumber);
void FONT_getPixLine(uint8_t pixLineNumber, uint8_t *pixLine);
bool FONT_isTxtLineAllSpaces(uint8_t pixLineNumber);
bool FONT_isStartingBlankLine(uint8_t pixLineNumber);
bool FONT_blackOnWhite = true;

// ==========================================================
// FONT

uint8_t FONT_charToIndex(char ch)
{
    if (islower(ch))
    {
        ch = toupper(ch);
    }
    uint8_t fontIndex;
    fontIndex = (isupper(ch)) ? (uint8_t)ch - (uint8_t)'A' + LETTER_A :
                (isdigit(ch)) ? (uint8_t)ch - (uint8_t)'0' + DIGIT_0  :
                (ch == ' ')   ? SPACE   :
                (ch == '<')   ? LT      :
                (ch == '>')   ? GT      :
                (ch == '%')   ? PERCENT :
                (ch == ':')   ? COLON   : 
                (ch == '/')   ? SLASH   :
                (ch == '-')   ? DASH    : (uint8_t)'X';
    return fontIndex;
}

uint8_t FONT_getTxtLineNumber(uint8_t pixLineNumber)
{
    return pixLineNumber / G_charHeight;
}

void FONT_getPixLine(uint8_t pixLineNumber, uint8_t *pixLine)
{
    uint8_t txtLineNumber = FONT_getTxtLineNumber(pixLineNumber);
    uint8_t fontLineIndex = (pixLineNumber % G_charHeight) + 1;
    bool isSpaceBetweenLines = (fontLineIndex >= G_fontHeight);
    char *txtLine = DISP_getLinePtr(txtLineNumber);
    USB_printGraphicsLineHeader(DISP_getShowGraphics());
    uint16_t txtLineIndex = 0;
    for (txtLineIndex = 0; txtLine[txtLineIndex] != '\0'; txtLineIndex++)
    {
        char ch = txtLine[txtLineIndex];
        uint8_t fontIndex = FONT_charToIndex(ch);
        uint8_t pixForOneLineOfChar = 0;
        if (!isSpaceBetweenLines)
        {
            pixForOneLineOfChar = G_font[fontIndex][fontLineIndex];
        }
        if (FONT_blackOnWhite) {
            pixForOneLineOfChar = ~pixForOneLineOfChar;
        }
        uint8_t pixLineByteIndex = txtLineIndex;
        DISP_append8BitsToPixLine(pixForOneLineOfChar, pixLine, pixLineByteIndex);
    }
    USB_printGraphicsLineTrailer(DISP_getShowGraphics());
}

bool FONT_isTxtLineAllSpaces(uint8_t pixLineNumber)
{
    uint8_t txtLineNumber = FONT_getTxtLineNumber(pixLineNumber);
    char *txtLine = DISP_getLinePtr(txtLineNumber);;
    uint8_t ii;
    for (ii=0; ii < G_txtCharPerLine; ii++)
    {
        if (!isspace(txtLine[ii])) return false;
    }
    return true;
}

bool FONT_isStartingBlankLine(uint8_t pixLineNumber)
{
    bool isStartingBlankLine = false;
    if (FONT_isTxtLineAllSpaces(pixLineNumber))
    {
        uint8_t fontLineIndex = (pixLineNumber % G_charHeight) + 1;
        if (fontLineIndex == 1)
        {
            isStartingBlankLine = true;
        }
    }
    return isStartingBlankLine;
}

void FONT_toggleBlackOnWhite(void)
{
    FONT_blackOnWhite = !FONT_blackOnWhite;
}

bool FONT_getBlackOnWhite(void)
{
    return FONT_blackOnWhite;
}


